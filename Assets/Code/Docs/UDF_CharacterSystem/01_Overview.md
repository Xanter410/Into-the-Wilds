# Character System — Overview

---

## Навигация

- **[Главная / Overview](01_Overview.md)**
- [Архитектура / Architecture](02_Architecture.md)
- [Возможные Улучшения / Feature Requests](03_Feature_Requests.md)  

---

## Описание

Система персонажей отвечает за создание, управление и отображение любых активных сущностей в игре.  
Частью данной системы является подсистема AI для NPC.

---

## Основные возможности

- Создание персонажей, как игровых так и неигровых
- Реализация AI подсистемы для NPC на основе `BehaviorTree`
- Настройка рендеринга персонажей и их анимаций на снове `StateMachine`
- Настройка связи между отдельными компонентами и инверсия управления на основе DI VContainer.

---

## Основы устройства

1. Каждый персонаж в своей основе представлен как [StateMachine](/../UDF_Tools/01_Overview.md) с состояниями вроде `Idle`, `Move`, `Attack`, `Dead`. Это базовый элемент для взаимодействия с внешним миром.
1. Каждый персонаж имеет систему управления:
	1. Игровой персонаж управляется `PlayerInput` на основе `Input System` 
	1. Неигровые персонажи управляются AI системой на основе [BehaviorTree](../UDF_Tools/01_Overview.md)
1. Для отображения персонажей используется несколько дополнительных классов с разной ответственностью:
	1. Универсальный `UnitSpriteRenderer` определяющий сторону в которую смотрит спрайт на основе данных о передвижении
	1. Специализированный `...AnimatorRenderer` управляющий Animator на основе данных из `StateMachine`.
1. Также CharacterSystem тесно связана с дополнительными компонентами для реализации более глубоких механик, например:
	1. HealthComponent - для реализации механики здоровья
	1. AttackTrigger - для реализации базовой боевой механики
	1. HitAndStunHandler - для увеличения импакта боевой системы
	1. DynamicSortingOrder - для правильного отображения в условиях Top-down 2D графики
	1. и т.д.

---

## Принцип работы

> В данной игре применяется инверсия управления, что особенно сильно сказалось на CharacterSystem.  
  Управление и инициация любых действий производится из чистых классов C#.  

Основной цикл работы для NPC:

1. AI система анализирует внешние условия и обновляет данные о вводе. Реализуя интерфейсы вроде `IMove`, `IAttack`.
1. StateMachine выполняет текущее состояние, которое опрашивает систему ввода.  
   В зависимости от ввода текущее состояние либо сохраняется (выполняя при этом какую-то работу, например передвижение),  
   либо делает активным другое состояние.
1. В случае изменения активного состояния StateMachine уведомляет элементы рендеринга и они меняют состояния внутри Animator  
   на соответствующие новому состоянию StateMachine

Также существуют состояния StateMachine, которые могут привелигированно вызвать сами себя, в случае внешнего события.  
Так работает `DeadState`, который подписан на событие `OnDead` компонента `HealthComponent`

---

> [Далее: Архитектура системы](02_Architecture.md)
